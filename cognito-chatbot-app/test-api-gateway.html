<!DOCTYPE html>
<html>
<head>
    <title>API Gateway Test</title>
    <script src="https://cdn.jsdelivr.net/npm/aws-amplify@6/dist/aws-amplify.min.js"></script>
</head>
<body>
    <h1>API Gateway Direct Test</h1>
    <p>This page tests calling API Gateway directly to diagnose authorization issues.</p>
    
    <div>
        <h2>Step 1: Configure Amplify</h2>
        <button onclick="configureAmplify()">Configure</button>
        <pre id="config-output"></pre>
    </div>
    
    <div>
        <h2>Step 2: Sign In</h2>
        <input type="email" id="email" placeholder="Email" value="test@example.com">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signIn()">Sign In</button>
        <pre id="signin-output"></pre>
    </div>
    
    <div>
        <h2>Step 3: Get Tokens</h2>
        <button onclick="getTokens()">Get Tokens</button>
        <pre id="tokens-output"></pre>
    </div>
    
    <div>
        <h2>Step 4: Test API Gateway</h2>
        <button onclick="testApiGateway()">Test with ID Token</button>
        <button onclick="testApiGatewayAccess()">Test with Access Token</button>
        <pre id="api-output"></pre>
    </div>

    <script type="module">
        const { Amplify, fetchAuthSession, signIn: amplifySignIn } = window.aws_amplify;
        
        let currentIdToken = null;
        let currentAccessToken = null;
        
        window.configureAmplify = function() {
            const config = {
                Auth: {
                    Cognito: {
                        userPoolId: 'eu-west-1_rLLm10IR8',
                        userPoolClientId: '3lobr0kqpgeq2eukq5r842j2a1',
                        region: 'eu-west-1'
                    }
                }
            };
            
            Amplify.configure(config);
            document.getElementById('config-output').textContent = 'Amplify configured!\n' + JSON.stringify(config, null, 2);
        };
        
        window.signIn = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const result = await amplifySignIn({ username: email, password });
                document.getElementById('signin-output').textContent = 'Sign in successful!\n' + JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('signin-output').textContent = 'Sign in failed:\n' + error.message;
            }
        };
        
        window.getTokens = async function() {
            try {
                const session = await fetchAuthSession();
                currentIdToken = session.tokens?.idToken?.toString();
                currentAccessToken = session.tokens?.accessToken?.toString();
                
                const output = {
                    hasIdToken: !!currentIdToken,
                    hasAccessToken: !!currentAccessToken,
                    idTokenPreview: currentIdToken ? currentIdToken.substring(0, 50) + '...' : null,
                    accessTokenPreview: currentAccessToken ? currentAccessToken.substring(0, 50) + '...' : null,
                };
                
                // Decode ID token
                if (currentIdToken) {
                    const parts = currentIdToken.split('.');
                    const payload = JSON.parse(atob(parts[1]));
                    output.idTokenPayload = payload;
                }
                
                document.getElementById('tokens-output').textContent = JSON.stringify(output, null, 2);
            } catch (error) {
                document.getElementById('tokens-output').textContent = 'Failed to get tokens:\n' + error.message;
            }
        };
        
        window.testApiGateway = async function() {
            if (!currentIdToken) {
                document.getElementById('api-output').textContent = 'Please get tokens first!';
                return;
            }
            
            const apiUrl = 'https://0vj230oez8.execute-api.eu-west-1.amazonaws.com/dev/chatbot/ask';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentIdToken}`
                    },
                    body: JSON.stringify({
                        question: 'Test question'
                    })
                });
                
                const output = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                };
                
                try {
                    output.body = await response.json();
                } catch {
                    output.body = await response.text();
                }
                
                document.getElementById('api-output').textContent = 'ID Token Test:\n' + JSON.stringify(output, null, 2);
            } catch (error) {
                document.getElementById('api-output').textContent = 'API call failed:\n' + error.message;
            }
        };
        
        window.testApiGatewayAccess = async function() {
            if (!currentAccessToken) {
                document.getElementById('api-output').textContent = 'Please get tokens first!';
                return;
            }
            
            const apiUrl = 'https://0vj230oez8.execute-api.eu-west-1.amazonaws.com/dev/chatbot/ask';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAccessToken}`
                    },
                    body: JSON.stringify({
                        question: 'Test question'
                    })
                });
                
                const output = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                };
                
                try {
                    output.body = await response.json();
                } catch {
                    output.body = await response.text();
                }
                
                document.getElementById('api-output').textContent = 'Access Token Test:\n' + JSON.stringify(output, null, 2);
            } catch (error) {
                document.getElementById('api-output').textContent = 'API call failed:\n' + error.message;
            }
        };
    </script>
</body>
</html>
